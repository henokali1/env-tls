{% extends 'base.html' %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Credentials</h1>
        {% if user.is_staff %}
        <a href="{% url 'credential_manage' %}" class="btn btn-primary">Manage Credentials</a>
        {% endif %}
    </div>

    <form method="get" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <select name="system"
            style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); min-width: 150px;">
            <option value="">All Systems</option>
            {% for s in systems %}
            <option value="{{ s.id }}" {% if request.GET.system == s.id|stringformat:"s" %}selected{% endif %}>
    {{ s.name }}
</option>
            {% endfor %}
        </select>
        
        <select name="location"
            style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); min-width: 150px;">
            <option value="">All Locations</option>
            {% for l in locations %}
            <option value="{{ l.id }}" {% if request.GET.location == l.id|stringformat:"s" %}selected{% endif %}>
                {{ l.name }}
            </option>
            {% endfor %}
        </select>

        <input type="text" name="q" placeholder="Search..." value="{{ request.GET.q|default:'' }}"
            style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); flex-grow: 1; min-width: 200px;">

        <button type="submit" class="btn btn-primary">Search</button>
        {% if request.GET.q or request.GET.system or request.GET.location %}
        <a href="{% url 'credential_list' %}" class="btn" style="border: 1px solid var(--border-color);">Clear</a>
        {% endif %}
    </form>
</div>

<div class="card" style="padding: 0; overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: var(--bg-color); border-bottom: 2px solid var(--border-color);">
                <th style="padding: 1rem; text-align: left;">System</th>
                <th style="padding: 1rem; text-align: left;">Location</th>
                <th style="padding: 1rem; text-align: left;">Description</th>
                <th style="padding: 1rem; text-align: left;">User</th>
                <th style="padding: 1rem; text-align: left;">Password</th>
                <th style="padding: 1rem; text-align: left;">IPv4</th>
                <th style="padding: 1rem; text-align: left;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for credential in object_list %}
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 1rem;">{{ credential.system }}</td>
                <td style="padding: 1rem;">{{ credential.location|default:"-" }}</td>
                <td style="padding: 1rem;">{{ credential.description|default:"-" }}</td>
                <td style="padding: 1rem;">{{ credential.username|default:"-" }}</td>
                <td style="padding: 1rem;">
                    {% if credential.password %}
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="password-field" id="pass-{{ credential.pk }}"
                            data-pass="{{ credential.password }}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        <button type="button" class="btn-icon"
                            onclick="togglePassword('{{ credential.pk }}')">üëÅÔ∏è</button>
                    </div>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td style="padding: 1rem;">{{ credential.ipv4|default:"-" }}</td>
                <td style="padding: 1rem;">
                    <a href="{% url 'credential_detail' credential.pk %}" class="btn"
                        style="background-color: var(--text-color); color: var(--bg-color); font-size: 0.8rem; padding: 0.25rem 0.5rem;">View</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="padding: 2rem; text-align: center;">No credentials found matching your criteria.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function togglePassword(pk) {
        const span = document.getElementById('pass-' + pk);
        const pass = span.getAttribute('data-pass');
        if (span.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
            span.textContent = pass;
        } else {
            span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        }
    }
</script>

<style>
    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0;
        color: var(--text-color);
    }

    .btn-icon:hover {
        opacity: 0.7;
    }
</style>
{% endblock %}